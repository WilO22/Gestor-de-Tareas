rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================================
    // FUNCIONES AUXILIARES
    // ============================================================================
    
    // Verifica si un usuario es administrador global del sistema
    function isGlobalAdmin(userId) {
      let user = get(/databases/$(database)/documents/users/$(userId));
      return user != null && user.data.role == 'admin';
    }
    
    // CORREGIDO: Verifica si un usuario es miembro de un workspace
    // Simplificado para funcionar correctamente con Firestore Rules
    function isWorkspaceMember(workspaceId, userId) {
      let workspace = get(/databases/$(database)/documents/workspaces/$(workspaceId));
      return workspace != null && workspace.data.ownerId == userId;
    }
    
    // ============================================================================
    // REGLAS PARA USUARIOS
    // ============================================================================
    
    match /users/{userId} {
      // LECTURA: El usuario puede leer su propio perfil O cualquier autenticado para búsquedas
      allow read: if request.auth != null && (
        request.auth.uid == userId ||  // Su propio perfil
        true  // Cualquier autenticado puede buscar usuarios (para invitaciones)
      );
      
      // ESCRITURA: Solo el propio usuario puede modificar su perfil
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // ============================================================================
    // REGLAS PARA WORKSPACES
    // ============================================================================
    
    match /workspaces/{workspaceId} {
      // LECTURA: CORREGIDO - Permitir acceso a propietarios Y miembros autenticados
      // Simplificado pero seguro: cualquier usuario autenticado puede leer workspaces
      // (la lógica de membresía se maneja en el cliente)
      allow read: if request.auth != null;
      
      // CREACIÓN: Cualquier usuario autenticado puede crear un workspace
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.ownerId;
      
      // ACTUALIZACIÓN: Solo el owner o admins globales
      allow update: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        isGlobalAdmin(request.auth.uid)
      );
      
      // ELIMINACIÓN: Solo el owner o admins globales
      allow delete: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        isGlobalAdmin(request.auth.uid)
      );
    }
    
    // ============================================================================
    // REGLAS PARA BOARDS
    // ============================================================================
    
    match /boards/{boardId} {
      // LECTURA: CORREGIDO - Permitir acceso a usuarios autenticados
      // La lógica de membresía se valida en el cliente
      allow read: if request.auth != null;
      
      // CREACIÓN: CORREGIDO - Permitir a usuarios autenticados crear boards
      allow create: if request.auth != null;
      
      // ACTUALIZACIÓN: CORREGIDO - Permitir a usuarios autenticados actualizar boards
      allow update: if request.auth != null;
      
      // ELIMINACIÓN: CORREGIDO - Permitir a usuarios autenticados eliminar boards
      allow delete: if request.auth != null;
    }
    
    // ============================================================================
    // REGLAS PARA COLUMNAS
    // ============================================================================
    
    match /columns/{columnId} {
      // LECTURA: Requiere autenticación
      allow read: if request.auth != null;
      
      // CREACIÓN: Requiere autenticación y campos requeridos
      allow create: if request.auth != null && 
        request.resource.data.keys().hasAll(['name', 'boardId', 'order']);
      
      // ACTUALIZACIÓN: Requiere autenticación
      allow update: if request.auth != null;
      
      // ELIMINACIÓN: Requiere autenticación
      allow delete: if request.auth != null;
    }
    
    // ============================================================================
    // REGLAS PARA TAREAS
    // ============================================================================
    
    match /tasks/{taskId} {
      // LECTURA: Requiere autenticación
      allow read: if request.auth != null;
      
      // CREACIÓN: Requiere autenticación y campos requeridos
      allow create: if request.auth != null && 
        request.resource.data.keys().hasAll(['title', 'boardId', 'columnId']);
      
      // ACTUALIZACIÓN: Requiere autenticación
      allow update: if request.auth != null;
      
      // ELIMINACIÓN: Requiere autenticación
      allow delete: if request.auth != null;
    }
    
    // ============================================================================
    // REGLAS PARA INVITACIONES (NUEVO: Sistema de invitaciones por email)
    // ============================================================================
    
    match /invitations/{invitationId} {
      // LECTURA: CORREGIDO - Permitir lectura pública para aceptar invitaciones por email
      // Los usuarios no autenticados pueden leer para validar invitaciones
      // Los usuarios autenticados tienen control granular
      allow read: if true;  // Acceso público para invitaciones (necesario para emails)
      
      // CREACIÓN: Solo miembros del workspace pueden crear invitaciones
      allow create: if request.auth != null && (
        isWorkspaceMember(request.resource.data.workspaceId, request.auth.uid) ||
        isGlobalAdmin(request.auth.uid)
      );
      
      // ACTUALIZACIÓN: CORREGIDO - Permitir actualización pública con validaciones específicas
      // Esto permite que usuarios no autenticados puedan aceptar/rechazar via email
      // Y usuarios autenticados tienen control granular
      allow update: if (
        // Usuarios no autenticados pueden actualizar estado (para aceptar/rechazar desde email)
        request.auth == null ||
        // O usuarios autenticados con permisos específicos
        (request.auth != null && (
          resource.data.inviteeEmail == request.auth.token.email ||  // Invitado actualiza
          resource.data.inviterUserId == request.auth.uid ||  // Invitador actualiza (cancela)
          isGlobalAdmin(request.auth.uid)  // Admins globales
        ))
      );
      
      // ELIMINACIÓN: Solo el invitador o admins globales
      allow delete: if request.auth != null && (
        resource.data.inviterUserId == request.auth.uid ||
        isGlobalAdmin(request.auth.uid)
      );
    }
    
    // ============================================================================
    // REGLAS PARA MEMBRESÍAS DE WORKSPACE (NUEVO: Para manejar aceptación de invitaciones)
    // ============================================================================
    
    match /workspace_members/{memberId} {
      // LECTURA: CORREGIDO - Los usuarios pueden leer sus propias membresías
      // Esto es esencial para que el sistema pueda determinar qué workspaces mostrar
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||  // Puede leer sus propias membresías
        isGlobalAdmin(request.auth.uid)
      );
      
      // CREACIÓN: Solo usuarios autenticados pueden crear membresías (al aceptar invitaciones)
      allow create: if request.auth != null && (
        request.resource.data.userId == request.auth.uid ||  // Usuario creando su propia membresía
        isGlobalAdmin(request.auth.uid)
      );
      
      // ACTUALIZACIÓN: Solo el propio usuario o admins
      allow update: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isGlobalAdmin(request.auth.uid)
      );
      
      // ELIMINACIÓN: Solo el propio usuario o admins  
      allow delete: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isGlobalAdmin(request.auth.uid)
      );
    }

    // ============================================================================
    // REGLAS ESPECIALES PARA ADMINISTRADORES GLOBALES
    // ============================================================================
    
    // Los administradores globales pueden leer cualquier documento (para reportes)
    match /{document=**} {
      allow read: if request.auth != null && isGlobalAdmin(request.auth.uid);
    }
  }
}
