---
// src/components/dashboard/WorkspacesViewIsland.astro
// Server Island para vista de workspaces - renderiza lista de workspaces del usuario

import WorkspaceCard from '../workspace/WorkspaceCard.astro';
import CreateWorkspaceModal from './CreateWorkspaceModal.astro';
void WorkspaceCard;

// Props para recibir userId y workspaces iniciales
// No se reciben props de userId, el island obtiene el usuario en el cliente
const showCreateButton = true;
const serverWorkspaces: any[] = [];
---

<div id="workspaces-view" class="workspaces-view-island w-full bg-transparent" data-island="workspaces-view">
  <div class="w-full px-6 md:px-12 xl:px-24 2xl:px-40">
    <!-- Header de la vista -->
    <div class="mb-12 pt-8">
      <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">
        Mis Espacios de Trabajo
      </h1>
      <p class="text-gray-600 mt-3 text-lg">
        Organiza tus proyectos y colabora con tu equipo
      </p>
    </div>
    <!-- Estado de loading -->
    <div id="loading-state" class="flex flex-col items-center justify-center py-24" style="display:none">
      <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-600 mb-6"></div>
      <div class="text-lg text-gray-600">Cargando workspaces...</div>
    </div>
    <!-- Grid de workspaces (se oculta si loading) -->
    <div id="workspaces-grid" class="grid gap-12 w-full grid-cols-[repeat(auto-fit,minmax(260px,1fr))]" style="display:none">
      <!-- Las tarjetas de workspaces se renderizan din√°micamente desde el script del island -->
    </div>
  </div>
  
  <!-- Estado vac√≠o (se muestra cuando no hay workspaces) -->
  <div id="empty-state" class="hidden col-span-full text-center py-16">
    <div class="max-w-md mx-auto">
      <div class="text-gray-400 mb-6">
        <svg class="w-20 h-20 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
      </div>
      <h3 class="text-xl font-semibold text-gray-900 mb-3">
        ¬°Comienza tu primer workspace!
      </h3>
      <p class="text-gray-600 mb-6">
        Los workspaces te ayudan a organizar proyectos y colaborar con tu equipo. 
        Crea uno para empezar.
      </p>
      {showCreateButton && (
        <button 
          class="create-workspace-btn bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors"
        >
          Crear Mi Primer Workspace
        </button>
      )}
    </div>
  </div>
  
  <!-- Estado de error -->
  <div id="error-state" class="hidden col-span-full text-center py-16">
    <div class="max-w-md mx-auto">
      <div class="text-red-400 mb-4">
        <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-gray-900 mb-2">
        Error al cargar workspaces
      </h3>
      <p class="text-gray-600 mb-4" id="error-message">
        Ha ocurrido un error inesperado
      </p>
      <button 
        id="retry-btn"
        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition-colors"
      >
        Reintentar
      </button>
    </div>
  </div>
</div>

<script>
  // Script hidratado para funcionalidad interactiva
  import { onAuthStateChanged, getAuth } from 'firebase/auth';
  import { subscribeToUserWorkspaces } from '../../firebase/api';
  import type { Workspace } from '../../types/domain';
  import type { Unsubscribe } from 'firebase/firestore';
  import { formatRelativeTime } from '../../utils/date.utils';
  import { app } from '../../firebase/client';

  console.log('üèùÔ∏è WorkspacesViewIsland: Hidratando en cliente');

  // Inicializar auth con la app
  const auth = getAuth(app);

  // Verificar que Firebase est√© disponible
  try {
    console.log('üèùÔ∏è WorkspacesViewIsland: Verificando Firebase auth:', !!auth);
    console.log('üèùÔ∏è WorkspacesViewIsland: Verificando Firebase app:', !!app);
  } catch (error) {
    console.error('üèùÔ∏è WorkspacesViewIsland: Error al verificar Firebase:', error);
  }

  console.log('üèùÔ∏è WorkspacesViewIsland: Hidratando en cliente');

  // Estado del componente
  interface ComponentState {
    workspaces: Workspace[];
    loading: boolean;
    error: string | null;
    user: any | null;
  }

  let state: ComponentState = {
    workspaces: [],
    loading: true,
    error: null,
    user: null
  };

  let workspacesUnsubscribe: Unsubscribe | null = null;

  // Funci√≥n para obtener elementos del DOM (din√°micamente)
  function getElements() {
    const grid = document.getElementById('workspaces-grid');
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');

    console.log('üèùÔ∏è WorkspacesViewIsland: getElements called:', {
      grid: !!grid,
      loadingState: !!loadingState,
      emptyState: !!emptyState,
      gridId: grid?.id
    });

    return {
      grid,
      loadingState,
      emptyState
    };
  }

  // Funci√≥n para actualizar visibilidad
  function updateVisibility() {
    const elements = getElements();
    if (state.loading) {
      elements.loadingState?.removeAttribute('style');
      elements.grid?.setAttribute('style', 'display:none');
      elements.emptyState?.classList.add('hidden');
    } else {
      elements.loadingState?.setAttribute('style', 'display:none');
      elements.grid?.removeAttribute('style');
      if (state.workspaces.length === 0) {
        elements.emptyState?.classList.remove('hidden');
      } else {
        elements.emptyState?.classList.add('hidden');
      }
    }
  }

  // Funci√≥n para renderizar workspaces
  function renderWorkspaces(workspaces: Workspace[]) {
    let elements = getElements();
    console.log('üèùÔ∏è WorkspacesViewIsland: Elementos encontrados:', {
      grid: !!elements.grid,
      gridId: elements.grid?.id,
      gridChildren: elements.grid?.children?.length
    });

    if (!elements.grid) {
      console.error('üèùÔ∏è WorkspacesViewIsland: Grid element not found');
      return;
    }

    state.loading = false;
    updateVisibility();

    console.log('üèùÔ∏è WorkspacesViewIsland: Renderizando', workspaces.length, 'workspaces');

    // HTML de la tarjeta de crear workspace (siempre al inicio)
    const createCardHTML = `
      <div>
        <div id="create-workspace-card" class="workspace-card-container cursor-pointer p-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-dashed border-blue-200 rounded-lg hover:border-blue-300 hover:bg-gradient-to-br hover:from-blue-100 hover:to-indigo-100 transition-all duration-200 group" role="button" tabindex="0">
          <div class="flex flex-col items-center justify-center space-y-4 h-full min-h-[200px]">
            <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center text-white shadow-lg group-hover:scale-110 transition-transform duration-200">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
            </div>
            <div class="text-center">
              <h3 class="text-lg font-semibold text-gray-900 mb-2">Crear Workspace</h3>
              <p class="text-sm text-gray-600">Organiza tus proyectos y colabora con tu equipo</p>
            </div>
          </div>
        </div>
      </div>
    `;

    // Renderizar workspaces
    const workspacesHTML = workspaces.map(workspace => {
      const memberCount = workspace.members?.length || 0;
      const boardCount = workspace.boards?.length || 0;
      const lastActivity = workspace.updatedAt ? new Date(workspace.updatedAt) : null;
      const isOwner = state.user && workspace.ownerId === state.user.uid;
      const colors = ['blue', 'green', 'purple', 'pink', 'indigo'];
      const colorIndex = workspace.id.charCodeAt(0) % colors.length;
      const color = colors[colorIndex];

      return `
        <div class="workspace-card-container" data-workspace-id="${workspace.id}">
          <a href="/workspace/${workspace.id}/boards" class="block p-6 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md hover:scale-105 transition-all duration-200">
            <div class="flex items-center space-x-3 mb-4">
              <div class="w-12 h-12 bg-${color}-500 rounded-lg flex items-center justify-center text-white font-bold text-lg shadow-md">
                ${workspace.name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2)}
              </div>
              <div class="flex-1 min-w-0">
                <h3 class="text-lg font-semibold text-gray-900 truncate">${workspace.name}</h3>
              </div>
              ${isOwner ? `
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                  Propietario
                </span>
              ` : ''}
            </div>
            <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
              <div class="flex items-center space-x-2 text-gray-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
                <span>${boardCount} ${boardCount === 1 ? 'tablero' : 'tableros'}</span>
              </div>
              <div class="flex items-center space-x-2 text-gray-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m3 5.197H9m3 0a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span>${memberCount} ${memberCount === 1 ? 'miembro' : 'miembros'}</span>
              </div>
            </div>
            <div class="flex items-center justify-between text-xs text-gray-500 pt-3 border-t border-gray-100">
              <div class="flex items-center space-x-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>
                  ${lastActivity ? `Actualizado ${formatRelativeTime(lastActivity)}` : 'Sin actividad reciente'}
                </span>
              </div>
            </div>
          </a>
        </div>
      `;
    }).join('');

    // Actualizar el grid con la tarjeta de crear + workspaces
    elements.grid.innerHTML = createCardHTML + workspacesHTML;

    // Configurar listener para la tarjeta de crear workspace
    setupCreateWorkspaceCardListener();
  }

  // Funci√≥n para configurar el listener de la tarjeta de crear workspace
  function setupCreateWorkspaceCardListener() {
    const createCard = document.getElementById('create-workspace-card');
    if (createCard) {
      console.log('üèùÔ∏è WorkspacesViewIsland: Create workspace card found, adding listener');

      // Remover listener anterior si existe
      if ((createCard as any)._createClickAttached) {
        createCard.removeEventListener('click', (createCard as any)._createClickFn);
        createCard.removeEventListener('keydown', (createCard as any)._createKeydownFn);
      }

        // Agregar nuevo listener para click
        const clickFn = (e: Event) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('üèùÔ∏è WorkspacesViewIsland: Click en crear workspace');

          // Disparar evento personalizado para abrir el modal
          const event = new CustomEvent('create-workspace-requested');
          document.dispatchEvent(event);
        };

        // Agregar nuevo listener para teclado (Enter y Space)
        const keydownFn = (e: KeyboardEvent) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            e.stopPropagation();
            console.log('üèùÔ∏è WorkspacesViewIsland: Keydown en crear workspace');

            // Disparar evento personalizado para abrir el modal
            const event = new CustomEvent('create-workspace-requested');
            document.dispatchEvent(event);
          }
        };      createCard.addEventListener('click', clickFn);
      createCard.addEventListener('keydown', keydownFn);

      (createCard as any)._createClickAttached = true;
      (createCard as any)._createClickFn = clickFn;
      (createCard as any)._createKeydownFn = keydownFn;
    } else {
      console.log('üèùÔ∏è WorkspacesViewIsland: Create workspace card not found, will retry in 1 second');
      setTimeout(setupCreateWorkspaceCardListener, 1000);
    }
  }

  // Funci√≥n para cargar workspaces
  function loadWorkspaces(user: any) {
    if (!user) {
      state.workspaces = [];
      state.loading = false;
      updateVisibility();
      renderWorkspaces([]);
      return;
    }

    console.log('üèùÔ∏è WorkspacesViewIsland: Cargando workspaces para usuario', user.uid);

    // Limpiar suscripci√≥n anterior
    if (workspacesUnsubscribe) {
      workspacesUnsubscribe();
    }

    try {
      // Suscribirse a workspaces del usuario
      workspacesUnsubscribe = subscribeToUserWorkspaces(user.uid, (workspaces) => {
        console.log('üèùÔ∏è WorkspacesViewIsland: Workspaces actualizados:', workspaces);
        console.log('üèùÔ∏è WorkspacesViewIsland: N√∫mero de workspaces:', workspaces.length);
        console.log('üèùÔ∏è WorkspacesViewIsland: √öltimo workspace:', workspaces[workspaces.length - 1]);

        state.workspaces = workspaces;
        state.loading = false;
        state.error = null;

        console.log('üèùÔ∏è WorkspacesViewIsland: Llamando renderWorkspaces...');
        renderWorkspaces(workspaces);
        console.log('üèùÔ∏è WorkspacesViewIsland: renderWorkspaces completado');
      });
    } catch (error) {
      console.error('üèùÔ∏è WorkspacesViewIsland: Error cargando workspaces:', error);
      state.loading = false;
      state.error = 'Error al cargar los workspaces';
      state.workspaces = [];
      renderWorkspaces([]);
    }
  }

  // Inicializaci√≥n del island
  function initializeWorkspacesViewIsland() {
    console.log('üèùÔ∏è WorkspacesViewIsland: Inicializando...');

    // Mostrar loading al inicio
    state.loading = true;
    updateVisibility();

    // Configurar listener de la tarjeta de crear workspace
    console.log('üèùÔ∏è WorkspacesViewIsland: Configurando listener para crear workspace...');
    setupCreateWorkspaceCardListener();

    // Suscribirse a cambios de autenticaci√≥n
    try {
      onAuthStateChanged(auth, (user) => {
        state.user = user;
        state.loading = true;
        updateVisibility();
        if (user) {
          console.log('üèùÔ∏è WorkspacesViewIsland: Usuario autenticado');
          loadWorkspaces(user);
        } else {
          console.log('üèùÔ∏è WorkspacesViewIsland: Usuario no autenticado');
          state.workspaces = [];
          state.loading = false;
          updateVisibility();
          renderWorkspaces([]);
        }
      });
    } catch (error) {
      console.error('üèùÔ∏è WorkspacesViewIsland: Error en autenticaci√≥n:', error);
      state.loading = false;
      state.workspaces = [];
      renderWorkspaces([]);
    }
  }

  // Auto-inicializaci√≥n
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeWorkspacesViewIsland);
  } else {
    initializeWorkspacesViewIsland();
  }

  console.log('üèùÔ∏è WorkspacesViewIsland: Script loaded completely');
</script>

<style>
  /* Estilos espec√≠ficos del WorkspacesViewIsland */
  .workspaces-view-island {
    min-height: 400px;
  }
  
  .workspace-card-container a:hover .group-hover\:opacity-100 {
    opacity: 1;
  }
  
  /* Fix para Tailwind din√°mico */
  .bg-blue-500 { background-color: #3b82f6; }
  .bg-green-500 { background-color: #10b981; }
  .bg-purple-500 { background-color: #8b5cf6; }
  .bg-pink-500 { background-color: #ec4899; }
  .bg-indigo-500 { background-color: #6366f1; }
</style>
