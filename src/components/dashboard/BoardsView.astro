---
// src/components/dashboard/BoardsView.astro

export interface Props {
  workspaceId?: string;
}
const { workspaceId } = Astro.props;
---

<div id="boards-content">
  <div class="flex items-center space-x-4 mb-8">
  </div>
  <div id="boards-view-grid" class="grid gap-12 w-full grid-cols-[repeat(auto-fit,minmax(260px,1fr))]">
    <p id="loading-message" class="col-span-full text-center py-16">Cargando tableros...</p>
  </div>
</div>

<script>
  console.log('ğŸ“‹ BoardsView: Componente actualizado cargado');

  // FunciÃ³n de inicializaciÃ³n
  async function initializeComponent() {
    console.log('ğŸ“‹ BoardsView: Inicializando componente...');

    // Importar dinÃ¡micamente el store
    const { dashboardView } = await import('../../store/store');

    // Escuchar cambios en el store
    const unsubscribe = dashboardView.subscribe((state) => {
      console.log('ğŸ“‹ BoardsView: Dashboard store cambiÃ³:', state);
      handleStoreChange(state);
    });

    // Verificar estado inicial
    const initialState = dashboardView.get();
    console.log('ğŸ“‹ BoardsView: Estado inicial del store:', initialState);
    await handleStoreChange(initialState);

    console.log('ğŸ“‹ BoardsView: Componente inicializado completamente');

    // Retornar funciÃ³n de cleanup
    return unsubscribe;
  }

  // FunciÃ³n para manejar cambios en el store
  async function handleStoreChange(state: { currentView: string; selectedWorkspaceId: string | null }) {
    console.log('ğŸ“‹ BoardsView: === handleStoreChange INICIADO ===');
    console.log('ğŸ“‹ BoardsView: Estado recibido:', JSON.stringify(state, null, 2));

    if (state.currentView === 'boards' && state.selectedWorkspaceId) {
      console.log('ğŸ“‹ BoardsView: âœ… CondiciÃ³n cumplida - currentView=boards, selectedWorkspaceId=', state.selectedWorkspaceId);

      // Asegurarse de que el contenedor del grid existe
      let gridContainer = document.getElementById('boards-view-grid');
      if (!gridContainer) {
        console.log('ğŸ“‹ BoardsView: Creando contenedor del grid...');
        const content = document.getElementById('boards-content');
        if (content) {
          const gridDiv = document.createElement('div');
          gridDiv.id = 'boards-view-grid';
          gridDiv.className = 'grid gap-12 w-full grid-cols-[repeat(auto-fit,minmax(260px,1fr))]';
          gridDiv.innerHTML = '<p id="loading-message" class="col-span-full text-center py-16">Cargando tableros...</p>';
          content.appendChild(gridDiv);
          gridContainer = gridDiv;
          console.log('ğŸ“‹ BoardsView: âœ… Contenedor creado exitosamente');
        } else {
          console.error('âŒ BoardsView: No se encontrÃ³ el elemento boards-content');
          return;
        }
      } else {
        console.log('ğŸ“‹ BoardsView: âœ… Contenedor ya existe');
      }

      try {
        console.log('ğŸ“‹ BoardsView: Importando mÃ³dulo board-grid...');
        // Importar y usar el mÃ³dulo TypeScript
        const { initBoardGrid } = await import('../../scripts/shared/board-grid');
        console.log('ğŸ“‹ BoardsView: âœ… MÃ³dulo importado, llamando initBoardGrid...');

        const cleanup = await initBoardGrid('boards-view-grid', state.selectedWorkspaceId, true, true);
        console.log('ğŸ“‹ BoardsView: âœ… initBoardGrid completado, cleanup:', !!cleanup);

        if (cleanup) {
          // Guardar referencia para cleanup si es necesario
          (window as any)._boardsViewCleanup = cleanup;
          console.log('ğŸ“‹ BoardsView: âœ… Cleanup guardado');
        }
      } catch (error) {
        console.error('âŒ BoardsView: Error al importar o ejecutar initBoardGrid:', error);
      }
    } else {
      console.log('ğŸ“‹ BoardsView: âŒ CondiciÃ³n NO cumplida - currentView:', state.currentView, 'selectedWorkspaceId:', state.selectedWorkspaceId);
      // Si no estamos en la vista de boards, limpiar
      if (state.currentView !== 'boards') {
        console.log('ğŸ“‹ BoardsView: Limpiando estado anterior...');
        if ((window as any)._boardsViewCleanup) {
          (window as any)._boardsViewCleanup();
          (window as any)._boardsViewCleanup = null;
          console.log('ğŸ“‹ BoardsView: âœ… Cleanup ejecutado');
        }
        // Limpiar el contenido del grid
        const gridContainer = document.getElementById('boards-view-grid');
        if (gridContainer) {
          gridContainer.innerHTML = '<p id="loading-message" class="col-span-full text-center py-16">Selecciona un workspace para ver sus tableros...</p>';
          console.log('ğŸ“‹ BoardsView: âœ… Contenedor limpiado');
        }
      }
    }

    console.log('ğŸ“‹ BoardsView: === handleStoreChange COMPLETADO ===');
  }

  // Inicializar
  console.log('ğŸ“‹ BoardsView: Iniciando inicializaciÃ³n...');
  initializeComponent().then(cleanup => {
    // Guardar cleanup function si es necesario
    (window as any)._boardsViewCleanup = cleanup;
  });
</script>