---
// src/pages/login.astro
import Layout from '../layouts/Layout.astro';
---
<Layout title="Iniciar Sesión">
  <main class="flex items-center justify-center min-h-screen">
    <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
      <h1 class="text-2xl font-bold text-center">
        Bienvenido
      </h1>

      <form id="auth-form" class="space-y-4">
        <!-- NUEVO: Campo displayName para registro (oculto por defecto) -->
        <div id="displayNameField" style="display: none;">
          <label for="displayName" class="block mb-2 text-sm font-medium">Nombre completo</label>
          <input 
            type="text" 
            id="displayName" 
            class="w-full px-3 py-2 border rounded-lg" 
            placeholder="Juan Pérez"
          />
        </div>
        
        <div>
          <label for="email" class="block mb-2 text-sm font-medium">Correo Electrónico</label>
          <input 
            type="email" 
            id="email" 
            class="w-full px-3 py-2 border rounded-lg" 
            placeholder="tu@correo.com"
            required 
          />
        </div>
        <div>
          <label for="password" class="block mb-2 text-sm font-medium">Contraseña</label>
          <input 
            type="password" 
            id="password" 
            class="w-full px-3 py-2 border rounded-lg" 
            placeholder="••••••••"
            required 
          />
        </div>
        
        <div class="flex flex-col gap-2">
          <button type="button" id="login-button" class="w-full px-4 py-2 text-white bg-blue-600 rounded-lg hover:bg-blue-700">
            Iniciar Sesión
          </button>
          <button type="button" id="register-button" class="w-full px-4 py-2 text-white bg-green-600 rounded-lg hover:bg-green-700">
            Registrarse
          </button>
          <!-- NUEVO: Botón para alternar entre login y registro -->
          <button type="button" id="toggle-mode" class="w-full px-4 py-2 text-blue-600 bg-transparent border border-blue-600 rounded-lg hover:bg-blue-50">
            ¿Ya tienes cuenta? Inicia sesión
          </button>
        </div>
      </form>
      <p id="feedback-message" class="text-sm text-center h-4"></p>
    </div>
  </main>
  <script>
  import { signIn, signUp } from '../firebase/auth';

  // OBTENEMOS los elementos
  const emailInput = document.getElementById('email') as HTMLInputElement;
  const passwordInput = document.getElementById('password') as HTMLInputElement;
  const displayNameInput = document.getElementById('displayName') as HTMLInputElement; // // NUEVO
  const displayNameField = document.getElementById('displayNameField') as HTMLDivElement; // // NUEVO
  const loginButton = document.getElementById('login-button');
  const registerButton = document.getElementById('register-button');
  const toggleModeButton = document.getElementById('toggle-mode'); // // NUEVO
  // AÑADIMOS la referencia al nuevo párrafo
  const feedbackMessage = document.getElementById('feedback-message');

  // // NUEVO: Estado para alternar entre login y registro
  let isRegistrationMode = false;

  // // NUEVO: Función para alternar entre modos
  function toggleMode() {
    isRegistrationMode = !isRegistrationMode;
    
    if (isRegistrationMode) {
      // // Mostrar modo registro
      if (displayNameField) displayNameField.style.display = 'block';
      if (loginButton) loginButton.style.display = 'none';
      if (registerButton) registerButton.style.display = 'block';
      if (toggleModeButton) toggleModeButton.textContent = '¿Ya tienes cuenta? Inicia sesión';
      const h1 = document.querySelector('h1');
      if (h1) h1.textContent = 'Crear cuenta';
    } else {
      // // Mostrar modo login
      if (displayNameField) displayNameField.style.display = 'none';
      if (loginButton) loginButton.style.display = 'block';
      if (registerButton) registerButton.style.display = 'none';
      if (toggleModeButton) toggleModeButton.textContent = '¿No tienes cuenta? Regístrate';
      const h1 = document.querySelector('h1');
      if (h1) h1.textContent = 'Iniciar Sesión';
    }
    
    // // Limpiar mensajes
    if (feedbackMessage) feedbackMessage.textContent = '';
  }

  // // NUEVO: Event listener para alternar modo
  toggleModeButton?.addEventListener('click', toggleMode);

  // Listener para el botón de INICIAR SESIÓN
  loginButton?.addEventListener('click', async (event) => {
    event.preventDefault(); 
    
    // Limpiamos mensajes anteriores
    if (feedbackMessage) feedbackMessage.textContent = '';
    
    const result = await signIn(emailInput.value, passwordInput.value);

    if (result.success) {
      window.location.href = '/dashboard';
    } else {
      // Si hay error, lo mostramos en el párrafo en rojo
      if (feedbackMessage && result.error) {
        feedbackMessage.textContent = result.error;
        feedbackMessage.style.color = 'red';
      }
    }
  });

  // Listener para el botón de REGISTRARSE - ACTUALIZADO para incluir displayName
  registerButton?.addEventListener('click', async (event) => {
    event.preventDefault();
    
    if (feedbackMessage) feedbackMessage.textContent = '';
    
    // // NUEVO: Incluir displayName en el registro
    const displayName = displayNameInput.value.trim() || undefined;
    const result = await signUp(emailInput.value, passwordInput.value, displayName);

    if (result.success) {
      // Si el registro es exitoso, mostramos un mensaje en verde
      if (feedbackMessage) {
        feedbackMessage.textContent = '¡Registrado exitosamente! Redirigiendo...';
        feedbackMessage.style.color = 'green';
      }
      // Esperamos un momento para que el usuario vea el mensaje y luego redirigimos
      setTimeout(() => {
        window.location.href = '/dashboard';
      }, 1500); // 1.5 segundos
    } else {
      // Si hay error, lo mostramos en el párrafo en rojo
      if (feedbackMessage && result.error) {
        feedbackMessage.textContent = result.error;
        feedbackMessage.style.color = 'red';
      }
    }
  });

  // // NUEVO: Inicializar en modo login por defecto
  document.addEventListener('DOMContentLoaded', () => {
    // // Configurar estado inicial (modo login)
    if (displayNameField) displayNameField.style.display = 'none';
    if (loginButton) loginButton.style.display = 'block';
    if (registerButton) registerButton.style.display = 'none';
    if (toggleModeButton) toggleModeButton.textContent = '¿No tienes cuenta? Regístrate';
  });
</script>
</Layout>