---
import Layout from '../layouts/Layout.astro';
import DashBoardHeader from '../components/dashboard/DashBoardHeader.astro';
import SidebarIsland from '../components/dashboard/SidebarIsland.astro';
import WorkspaceGrid from '../components/dashboard/WorkspaceGrid.astro';
import BoardOverview from '../components/dashboard/BoardOverview.astro';
import MemberManagement from '../components/dashboard/MemberManagement.astro';
void MemberManagement;
import MemberOptionsModal from '../components/ui/MemberOptionsModal.astro';
import Toast from '../components/ui/Toast.astro';
---

<Layout title="Dashboard - TaskFlow">
  <DashBoardHeader />
  
  <div class="flex h-screen bg-gray-100">
  <SidebarIsland client:load />
    
    <main class="flex-1 overflow-auto p-6">
      <div id="loading-screen" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
        <div class="text-center">
          <div class="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600"></div>
          <p class="mt-4 text-gray-600">Cargando dashboard...</p>
        </div>
      </div>
      
      <div id="app-container" class="hidden">
        <div id="workspaces-view" class="space-y-6">
          <div class="flex items-center justify-between">
            <h1 class="text-3xl font-bold text-gray-900">Mis Espacios de Trabajo</h1>
            <button id="create-workspace-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
              Crear Workspace
            </button>
          </div>
          
          <WorkspaceGrid />
        </div>
        
        <BoardOverview />
      </div>
    </main>
  </div>
  
  <MemberOptionsModal />
  <Toast />
</Layout>

<script>
  // Keep non-duplicating imports and utilities. The islands manage workspace subscriptions/rendering.
  import { auth } from '../firebase/auth';
  import { onAuthStateChanged } from 'firebase/auth';
  import '../scripts/member-management';

  const loadingScreen = document.getElementById('loading-screen');
  const appContainer = document.getElementById('app-container');

  function hideLoading() {
    loadingScreen?.classList.add('hidden');
    appContainer?.classList.remove('hidden');
  }

  // Only handle authentication state for showing the main UI. Do NOT re-subscribe to workspaces here
  // — islands (Sidebar, WorkspacesView) perform their own subscriptions.
  onAuthStateChanged(auth, (user) => {
    if (user) {
      hideLoading();
      // broadcast authenticated user so islands/controllers can pick it up if needed
      document.dispatchEvent(new CustomEvent('user-authenticated', { detail: { uid: user.uid, email: user.email } }));
    } else {
      window.location.href = '/login';
    }
  });

  // Expose simple helpers that do not re-subscribe to workspaces.
  function showCreateWorkspaceModal() {
    // Forward as an event - islands or a controller can handle it centrally
    document.dispatchEvent(new CustomEvent('create-workspace-requested'));
  }

  function showCreateBoardModal() {
    document.dispatchEvent(new CustomEvent('create-board-requested'));
  }

  (window as any).showCreateWorkspaceModal = showCreateWorkspaceModal;
  (window as any).showCreateBoardModal = showCreateBoardModal;
</script>

<style>
  .tab-btn {
    transition: all 0.2s ease-in-out;
  }
  
  .tab-btn:hover {
    color: #374151;
  }
  
  .tab-content {
    animation: fadeIn 0.3s ease-in-out;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
